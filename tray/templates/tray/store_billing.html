{% extends "tray/base.html" %}

{% block navbar %}
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <li class="nav-item active">
    <a class="navbar-brand" href="{% url 'entry' %}">Home</a>
  </li>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="navbarSupportedContent">
    <ul class="navbar-nav mr-auto">
      <li class="nav-item">
        <a class="nav-link" href="{% url 'student_pin_edit' %}">Edit Pin</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="{% url 'student_logout' %}">Logout</a>
      </li>
      
    </ul>
    
  </div>
</nav>
{% endblock %}


{% block title%} Welcome to {{store.store_name}} {% endblock %}

{% block content %}
<center>
<!--p>Hi {{student.name}}</p>
<p> Welcome to {{store.store_name}}</p>
<p>Your balance: {{student.balance}}</p-->
<h2>Billing</h2>
<br/>

<table style="width: 20%;" >
    <thead>
        <tr >
            <th> Item | Price/unit</th>
            <th> Quantity</th>
        </tr>
    </thead>
    <tbody>
        <tr >
            <td>
                <select name="item_name" id="item" class="btn dropdown-toggle" aria-placeholder="selects" style="background-color: azure;">
                    
                    
                        <option value="none" selected disabled hidden> 
                            Select an Option 
                        </option> 

                    {% for item in items %}
                    <option input value="{{item.item}}">{{item.item}} : Rs. {{item.price}} </option>
                    {% endfor %}
                </select>
            </td>
            
            <td>
                <input type="number" style="width: 100%;" name="quantity" id="quantity" required>
            </td>
        </tr>
    </tbody>
</table>
<br/>



<br/>
<input type="hidden" name="store_id" value="{{store.id}}">
<input type="hidden" name="student_id" value="{{student.id}}">

<br/>

<button class="btn btn-success" type="button" id="add">Add to cart <!--div class="fa-3x">
  <i class="fas fa-spinner fa-spin"></i></div--> </button>
<br/> <br/>

<h3><strong>Cart</strong><i class="fas fa-shopping-cart"></i></h3>


<table id="cart_table" style="background-color: rgba(249, 251, 252, 0.746); width: 20%;" class="table table-striped" class="table-responsive-xs" >
<thead>
    <tr style="background-color: rgba(205, 248, 255, 0.52);" >
    <th>Item</th>
    <th>Qty</th>
    <th>Price</th>
    <th>Subtotal</th>
    <th>Action</th>
    </tr>
</thead>
<tbody id="cart_body" >
<!--this is the cart table where items are added by jquery-->
</tbody>
<tfoot>
    <tr>
        <!--td colspan="1"><strong>Total:</strong></td-->
        <td colspan="2" id="total">Total:</td>
        <td colspan="2" id="tray_revenue"></td>
        <td><button id="delete" class="btn btn-danger"><i class="fa fa-trash-o" aria-hidden="true"></i></button></td>
    </tr>
</tfoot>
</table>
<br/>
<h3>Enter amount given by customer</h3>
<input type="number" style="width:150px" name="customer_cash" id="customer_cash"/>
<button id="check_balance" class="btn btn-info">Check balance</button>
<br/><br/>
<h3 class="btn-grad" id="balance" >Balance: nil  </h3>

<h4>Payment Confirmation:</h4>

<input type="button"  id="confirm" value="CONFIRM" class="btn btn-primary"> 

{% with student_id=student.id  %}
{% with store_id=store.id %}





<script>
//add items to cart
    $(document).ready(function(){
    var total = 0;
    var buy_clicked = false;
    var order_list = [];

$("#check_balance").click(function(){
    customer_balance();
});

//function to return customer balance
function customer_balance(){
    customer_cash = $("#customer_cash").val();
    balance = parseFloat(customer_cash) - total;
    if (balance < 0){
        $("#balance").text("Insufficient payment");
    }
    else{
    $("#balance").text("Balance: "+balance);
    }
}



//function to calculate commission on adding item
    function alltray_revenue(total){

        if (total>0 && total<=10){
            commission = 0.01 * total;
        }
        else if (total>10 && total<=50){
            commission = 0.5;
        }
        else if (total>50 && total<=100){
            commission = 1;
        }
        else if (total>100 && total<=400){
            commission = 0.01 * total;
        }
        else if (total>=400){
            commission = 4;
        }
        else{
            commission = 0;
        }

        return commission;
    };


            $("#add").click(function(event){
                var item = $("#item").val();
                var quantity = $("#quantity").val();
                var new_item = true; 
                //check_exist_in_cart(item);
                if (quantity == ' ' || quantity < 1  ){
                    alert ("please select atleast one in quantity");
                    return;
                }
                console.log("entering exist check function"+ typeof item);
                check_exist_in_cart(item)
                //checking if item already in cart and incrementing the item
                function check_exist_in_cart(item){
                    $("#cart_body").find(id="#item").each(function(){
                            console.log("checking through each"+$(this).text());
                            cart_item = $(this).text()
                            if(cart_item == item)
                            {
                                console.log("already existing"+cart_item);
                                new_item = false;
                                quantity_in_cart = $(this).next().text();
                                quantity_in_cart = parseInt(quantity_in_cart) + parseInt(quantity);
                                console.log("quantity is"+ quantity_in_cart);
                                $(this).next().text(quantity_in_cart);
                                let price = $(this).next().next().text();
                                console.log("updater item price"+ price);
                                let cost = price * quantity_in_cart;
                                $(this).next().next().next().text(cost);
                            }
                        
                        
                    });
                } 

               
                            //adding order to list if it is a new item
                            if (new_item){
                             //sending item selected through ajax to get back the price of item.
                                $.ajax({
                                    url: '/ajax/billing/item_price/',
                                    data: {
                                        'item_name' : item,
                                        'store_id' : '{{store.id}}'
                                    },
                                    dataType: 'json',
                                    success: function (data){
                                            let i = 0;
                                            var item_price = data.item_price;
                                            let cost = quantity * item_price;
                                            console.log("total:"+total);
                                            var item_row = '<tr id='+i+'> <td id="item">'+item+'</td> <td>'+quantity+'</td> <td>'+ item_price +'</td> <td id="cost">'+cost+'</td> <td><input type="checkbox" name="record"></td> </tr>';
                                            $("#cart_table").find('tbody').append(item_row);
                                            
                                            //update_total();
                                            i++;


                                            order_obj = {
                                            "item":item,
                                            "quantity":quantity,
                                            "price": item_price,
                                            }
                                        order_list_push();
                                    }
                                });
                            } 
                update_total();
                //alltray_revenue(total);
                
            });
            
            function update_total(){
                total = 0;
                $("#cart_body").find(id="#cost").each(function(){
                    cost = parseInt($(this).text());
                    total += parseInt(cost);
                    console.log("UPDATED total_________________________________"+total);
                    $("#total").text("Total: "+total);
                });
            }

            function order_list_push(){
                order_list.push(order_obj);
                for(let i in order_list){
                    console.log("item:"+i+" "+order_list[i].item+" quantity:"+order_list[i].quantity+" time:"+order_list[i].time)
                }
            } 

            
            









            $("#delete").click(function(){
                $("#cart_body").find('input[name="record"]').each(function(){
            	if($(this).is(":checked")){
                    var delete_item_id = $(this).closest('tr').attr('id');
                    var item_cost = $(this).parent().prev().text();
                    var item_name = $(this).parent().prev().prev().prev().prev().text();
                    console.log(delete_item_id+ "testeritem: "+item_name+" deleting with cost : " +item_cost);
                    //removing the item from order list array
                    delete_from_order_list(item_name, item_cost);
                }
                });
                    function delete_from_order_list(item_name, item_cost)
                    {
                        console.log("entered delete function, item name:"+item_name+item_cost);
                        //item to be removed be prepared as this object on delete click
                        //remobj = {item:"samosa", quantity:"2", time:"Now" }
                        find_index = order_list.findIndex(a => (a.item === item_name && a.quantity === a.quantity));
                        console.log("index check"+find_index);
                        if (find_index !== -1){
                            order_list.splice(find_index,1);
                            console.log("removed");
                        }
                        //removing from cart table
                        $(this).parents("tr").remove();
                        console.log("total:"+subtotal);
                        subtotal = subtotal - item_cost;
                        console.log("total after deleting item:"+subtotal+"item_cost:"+item_cost );
                        $("#total").text("Total: "+subtotal);
                        tray_revenue = "tray revenue: "+alltray_revenue(subtotal);
                        $("#tray_revenue").text(tray_revenue);
                
                    }
           });
       });

    //confirming purchase and saving to order table
    $("#confirm").click(function(){
                buy_clicked = true;
                Swal.fire(
                    'Order confirmed',
                    '<p>invoice has been downloaded to your browser as pdf. <br/>Thanks for Shopping with Alltray!<p>',
                    'success'
                    ).then(function() {
                        location.reload();
                    });
    
                           /* if (data.status == 'no_item_in_cart')
                            {
                            alert("No item in cart");
                            total = 0;
                            subtotal = 0;
                            }
                            */
            

                });





//clear cart on exit 
window.onbeforeunload = function(event) {
    if (buy_clicked == false){
        event.returnValue = "exit"
            total = 0;
            subtotal = 0;
        }
               

            }; 
  
    
</script>
{% endwith %}
{% endwith %}

</center>  
{% endblock %}