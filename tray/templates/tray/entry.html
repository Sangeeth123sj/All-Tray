{% extends "tray/base.html" %}

{% block title%} {% endblock %}



                {% block heading %}
{% load crispy_forms_tags %}


        
                        <div class="heading" style="text-align: center;" >
                            <strong>All Tray</strong>
                        </div>
                        {% endblock %}
                        {% block content %}

                    <div class="form-group centered">
                
                    <center>     
                        <form action="/home_post/" class="form" method="POST" >
                            {% csrf_token %}
                            {{ form|crispy }}
                        <!--class 'fixed' to hide rfid card number input field-->
                        <div class="fixed">
                            <div class="form-group">
                            <input type="number" id="id_card" name="student_id" autofocus >
                            </div>
                        </div>
                        

                        <div class="form-group">
                            <p><strong>username</strong></p>
                            <div class="container">
                                <div class="col-xs-2">
                                    <input type="text" class="form-control" id="username" name="username"><br/>
                                </div>
                            </div>
                        </div>
                        <div class="container">
                        <Strong>Pin</strong>
                        <br/>
                        <input type="password" id="pin" name="student_pin" class="form-control"> 
                        </div>
                        <br>
                    <div class="container">
                        <i>Swipe id card / enter pin</i>
                        <br/>
                        <p id="incorrect_alert_1" style="color: rgb(131, 54, 54); font-weight: 1000; width: fit-content; display:none;" ></p>
                        <p id="incorrect_alert_2" style="color: rgb(80, 32, 32); font-weight: 1000; width: fit-content; display:none;" ></p>

                        <div>
                        <input type="button" id="enter" class="btn btn-primary btn-block " value="Enter">
                        </div>
                        <br/><br/>
                        <p style="font-style:unset;">Not yet started with All Tray?<br/>
                        Start now!</p>
                    </div>
                        <a href="{% url 'register_card' %}" class="btn btn-success">Register card</a>
                        <br/>
                        {%block footer%} {% endblock %}
                        </form>
                    </center>  
                </div>
            </div>
        
                   
     
    
</div>

</div>

<script>
//checking if pin or id card entered
$(document).ready(function(){

        //storing field variables to browser before reloading page
        //filling fields with values on reload
        //window.onload=set_fields();

        function set_fields(){
            var pin = sessionStorage.getItem('pin');
            if (pin !== null) $('#pin').val(pin);
        }

        window.onbeforeunload = function() {
            sessionStorage.setItem("pin", $('#pin').val());
        }


    //submit click
    $("#enter").click(function(event){
                
        if ( $("#username").val() == "" ) {
                document.getElementById("incorrect_alert_1").innerHTML = "Please enter username."
                $("#username").css("border-color","red"); 
                //$("#incorrect_alert_1").fadeIn(1000).delay(4000).fadeOut(1000);
                event.preventDefault();
            }

        if ($("#id_card").val() == "" && $("#pin").val() == ""){
                $("#pin").css("border-color","red");
                document.getElementById("incorrect_alert_2").innerHTML = "Please enter pin or refresh and swipe card first then enter username."
                $("#incorrect_alert_2").fadeIn(1000).delay(4000).fadeOut(1000);
                event.preventDefault();
            }
        
        else if ( ($("#username").val() == "" && $("#id_card").val() != "" )||( $("#username").val() =="" && $("#pin").val() != "") ) {       
                    document.getElementById("incorrect_alert_1").innerHTML = "Please enter username or refresh and swipe card first then enter username."
                    $("#incorrect_alert_1").fadeIn(1000).delay(4000).fadeOut(1000);
                    event.preventDefault();
                    console.log(username);
                    console.log(pin);
                    console.log(id_card);
                }

        else{
            console.log("test on enter button");
                    var username =  $("#username").val();
                    var pin = $("#pin").val();
                    var id_card = $("#id_card").val();
                    console.log(username);
        //sending form fields in ajax for checking if registered pin or card
                $.ajax({
                    url: '/ajax/validate_entry/',
                    data: {
                        'username': username,
                        'pin': pin,
                        'id_card': id_card,
                    },
                    dataType: 'json',
                    success: function (data){
                            if (data.incorrect_status == "wrong_username"){
                                document.getElementById("incorrect_alert_1").innerHTML = "Sorry incorrect pin or unregistered card, please register if not registered and try again"
                                alert("Sorry non-existent user  please register if not registered and try again");
                                $("#pin").css("border-color","red");
                                location.reload();
                            }
                            if (data.incorrect_status == "incorrect_pin&card"){
                                document.getElementById("incorrect_alert_1").innerHTML = "Sorry incorrect pin or unregistered card, please register if not registered and try again"
                                alert("Sorry incorrect pin/card  please register if not registered and try again");
                                $("#pin").css("border-color","red");
                                location.reload();
                            }
                            if (data.incorrect_status == "correct"){
                                $("form").submit();
                            }
                        }
                        
                });  
            }

    });  //enter button click function closing
});
        

</script>


{% endblock %}